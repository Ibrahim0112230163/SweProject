# ğŸ® Knowledge Dungeon - System Architecture

## ğŸ“Š Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      STUDENT UPLOADS PDF                     â”‚
â”‚                   (Syllabus Analyzer)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   COURSE_ANALYSIS TABLE                      â”‚
â”‚  â€¢ extracted_skills: ["Python", "Algorithms"]               â”‚
â”‚  â€¢ learning_outcomes: ["Build binary tree"]                 â”‚
â”‚  â€¢ raw_content: "Full syllabus text..."                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STUDENT STARTS DUNGEON GAME                     â”‚
â”‚           (Selects: Easy/Medium/Hard)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                               â”‚
         â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CREATE GAME RUN  â”‚           â”‚  GENERATE QUESTIONS â”‚
â”‚  (dungeon_runs)  â”‚           â”‚   (Google Gemini)   â”‚
â”‚                  â”‚           â”‚                     â”‚
â”‚ â€¢ user_id        â”‚           â”‚ Prompt includes:    â”‚
â”‚ â€¢ difficulty     â”‚           â”‚ â€¢ Skills to test    â”‚
â”‚ â€¢ total_rooms: 5 â”‚           â”‚ â€¢ Learning outcomes â”‚
â”‚ â€¢ current_hp:100 â”‚           â”‚ â€¢ Syllabus content  â”‚
â”‚ â€¢ score: 0       â”‚           â”‚ â€¢ Difficulty level  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                â”‚
         â”‚                                â”‚
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚    â”‚
         â–¼    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GAMEPLAY LOOP (5 ROOMS)                   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ROOM 1: Question about "Binary Search Trees"      â”‚    â”‚
â”‚  â”‚  â€¢ Question: "To unlock this gate, explain..."     â”‚    â”‚
â”‚  â”‚  â€¢ 4 Answers (1 correct, 3 wrong)                  â”‚    â”‚
â”‚  â”‚  â€¢ Hint: Extract from syllabus if potion used      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â”‚                                   â”‚
â”‚                          â–¼                                   â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚           â”‚   STUDENT SELECTS ANSWER     â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                          â”‚                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â”‚                      â”‚                       â”‚
â”‚         CORRECT?              INCORRECT?                    â”‚
â”‚              â”‚                      â”‚                       â”‚
â”‚              â–¼                      â–¼                       â”‚
â”‚      â€¢ Score +20 pts        â€¢ HP -20                        â”‚
â”‚      â€¢ Add to mastered      â€¢ Add to failed_skills         â”‚
â”‚                                                              â”‚
â”‚                    (Repeat for 5 rooms)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                               â”‚
    HP > 0?                          HP = 0?
         â”‚                               â”‚
         â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   VICTORY! ğŸ†    â”‚           â”‚   GAME OVER ğŸ’€      â”‚
â”‚                  â”‚           â”‚                     â”‚
â”‚ â€¢ Update XP      â”‚           â”‚ â€¢ Generate Study    â”‚
â”‚ â€¢ Level up       â”‚           â”‚   Report            â”‚
â”‚ â€¢ Status: done   â”‚           â”‚ â€¢ Show failed skillsâ”‚
â”‚ â€¢ Show score     â”‚           â”‚ â€¢ Recommendations   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   UPDATE GAME_STATS                          â”‚
â”‚  â€¢ total_experience_points += score                         â”‚
â”‚  â€¢ level = FLOOR(total_xp / 100) + 1                        â”‚
â”‚  â€¢ total_dungeons_completed++                               â”‚
â”‚  â€¢ total_rooms_cleared += rooms_cleared                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—„ï¸ Database Schema Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    auth.users       â”‚
â”‚  (Supabase Auth)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ user_id (FK)
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                                  â”‚
           â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   course_analysis   â”‚          â”‚    game_stats       â”‚
â”‚  (from Analyzer)    â”‚          â”‚  (1 per user)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ extracted_skills  â”‚          â”‚ â€¢ level             â”‚
â”‚ â€¢ learning_outcomes â”‚          â”‚ â€¢ total_xp          â”‚
â”‚ â€¢ raw_content       â”‚          â”‚ â€¢ health_potions    â”‚
â”‚ â€¢ course_title      â”‚          â”‚ â€¢ dungeons_done     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                                  
           â”‚ course_id (FK)                   
           â”‚                                  
           â–¼                                  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      
â”‚   dungeon_runs      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  (game sessions)    â”‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
â”‚ â€¢ difficulty        â”‚                      â”‚
â”‚ â€¢ total_rooms       â”‚                      â”‚
â”‚ â€¢ rooms_cleared     â”‚                      â”‚
â”‚ â€¢ current_hp        â”‚                      â”‚
â”‚ â€¢ score             â”‚                      â”‚
â”‚ â€¢ status            â”‚                      â”‚
â”‚ â€¢ failed_skills     â”‚    dungeon_run_id    â”‚
â”‚ â€¢ mastered_skills   â”‚         (FK)         â”‚
â”‚ â€¢ study_report      â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
                                             â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚   room_attempts     â”‚
                                â”‚ (each question)     â”‚
                                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                â”‚ â€¢ room_number       â”‚
                                â”‚ â€¢ skill_tested      â”‚
                                â”‚ â€¢ question_text     â”‚
                                â”‚ â€¢ correct_answer    â”‚
                                â”‚ â€¢ student_answer    â”‚
                                â”‚ â€¢ is_correct        â”‚
                                â”‚ â€¢ hint_used         â”‚
                                â”‚ â€¢ time_spent        â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ API Request Flow

### 1. Start Game
```
POST /api/dungeon/run
  â†“
Create dungeon_run record
  â†“
Return dungeonRunId
```

### 2. Generate Questions
```
POST /api/dungeon/generate
  â†“
Fetch course_analysis by courseId
  â†“
If not found â†’ Use default "Computer Science"
  â†“
Build AI prompt with:
  â€¢ Skills to test
  â€¢ Learning outcomes
  â€¢ Syllabus content (first 3000 chars)
  â€¢ Difficulty level
  â†“
Call Google Gemini API
  â†“
Parse JSON response
  â†“
Return 5 dungeon-themed questions
```

### 3. Submit Answer
```
POST /api/dungeon/answer
  â†“
Create room_attempt record
  â†“
Calculate:
  â€¢ isCorrect = (studentAnswer === correctAnswer)
  â€¢ hpDamage = isCorrect ? 0 : 20
  â€¢ scoreEarned = isCorrect ? (hintUsed ? 10 : 20) : 0
  â†“
Update dungeon_run:
  â€¢ current_hp -= hpDamage
  â€¢ score += scoreEarned
  â€¢ rooms_cleared++ (if correct)
  â€¢ failed_skills (track mistakes)
  â€¢ mastered_skills (track success)
  â†“
Check end conditions:
  â€¢ HP = 0 â†’ Generate study_report
  â€¢ All rooms cleared â†’ Mark complete
  â†“
Return game state
```

### 4. Auto-Update Stats (Trigger)
```
When dungeon_run.status â†’ 'completed'
  â†“
Trigger: update_game_stats_after_run()
  â†“
Update game_stats:
  â€¢ total_xp += score
  â€¢ level = FLOOR(total_xp / 100) + 1
  â€¢ total_dungeons_completed++
  â€¢ total_rooms_cleared += rooms_cleared
```

## ğŸ¯ AI Question Generation Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INPUT: Course Analysis + Difficulty + Number of Questions  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BUILD AI PROMPT                           â”‚
â”‚                                                              â”‚
â”‚  "You are a dungeon master creating challenges..."          â”‚
â”‚                                                              â”‚
â”‚  CONTEXT:                                                    â”‚
â”‚  â€¢ Skills: ["Python", "Algorithms", "Data Structures"]      â”‚
â”‚  â€¢ Outcomes: ["Build binary tree", "Implement sort"]        â”‚
â”‚  â€¢ Difficulty: medium                                        â”‚
â”‚  â€¢ Syllabus excerpt: "Week 1: Binary trees..."             â”‚
â”‚                                                              â”‚
â”‚  TASK:                                                       â”‚
â”‚  Generate 5 dungeon-themed questions with:                  â”‚
â”‚  1. Creative scenario (gate/chamber/scroll theme)           â”‚
â”‚  2. One correct answer                                       â”‚
â”‚  3. Three plausible wrong answers                           â”‚
â”‚  4. Explanation                                              â”‚
â”‚  5. Hint extracted from syllabus                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               GOOGLE GEMINI API CALL                         â”‚
â”‚            (gemini-3-flash-preview)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PARSE JSON RESPONSE                        â”‚
â”‚                                                              â”‚
â”‚  [                                                           â”‚
â”‚    {                                                         â”‚
â”‚      "skill": "Binary Search Trees",                         â”‚
â”‚      "difficulty": "medium",                                 â”‚
â”‚      "question": "To pass through the ancient gate...",      â”‚
â”‚      "correctAnswer": "Insert as left child if smaller",     â”‚
â”‚      "wrongAnswers": [...],                                  â”‚
â”‚      "explanation": "BST maintains order property...",       â”‚
â”‚      "hintFromSyllabus": "Week 3 notes: BST insertion..."   â”‚
â”‚    },                                                        â”‚
â”‚    ...4 more questions                                       â”‚
â”‚  ]                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RETURN TO FRONTEND                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Security (Row Level Security)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ALL QUERIES AUTOMATICALLY FILTERED BY auth.uid()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ game_stats: WHERE user_id = auth.uid()
         â”‚
         â”œâ”€ dungeon_runs: WHERE user_id = auth.uid()
         â”‚
         â””â”€ room_attempts: WHERE EXISTS (
                SELECT 1 FROM dungeon_runs 
                WHERE id = room_attempts.dungeon_run_id 
                AND user_id = auth.uid()
            )

Students can ONLY see/modify their OWN data
```

## ğŸ“± Component Hierarchy

```
app/dashboard/dungeon/page.tsx (DungeonPage)
  â”‚
  â”œâ”€ GameStats Cards (Level, XP, Dungeons, Potions)
  â”‚
  â”œâ”€ Tabs
  â”‚   â”‚
  â”‚   â”œâ”€ Tab: "Play"
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€ Difficulty Selector (Easy/Medium/Hard)
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€ components/dashboard/dungeon-game.tsx (DungeonGame)
  â”‚   â”‚       â”‚
  â”‚   â”‚       â”œâ”€ State: menu
  â”‚   â”‚       â”‚   â””â”€ How to Play instructions
  â”‚   â”‚       â”‚
  â”‚   â”‚       â”œâ”€ State: loading
  â”‚   â”‚       â”‚   â””â”€ AI generating questions...
  â”‚   â”‚       â”‚
  â”‚   â”‚       â”œâ”€ State: playing
  â”‚   â”‚       â”‚   â”œâ”€ Status Bar (HP, Score, Potions)
  â”‚   â”‚       â”‚   â”œâ”€ Question Card
  â”‚   â”‚       â”‚   â”œâ”€ Hint Display (if potion used)
  â”‚   â”‚       â”‚   â”œâ”€ Answer Options (4 buttons)
  â”‚   â”‚       â”‚   â””â”€ Result & Explanation
  â”‚   â”‚       â”‚
  â”‚   â”‚       â””â”€ State: gameOver
  â”‚   â”‚           â”œâ”€ Victory/Defeat screen
  â”‚   â”‚           â”œâ”€ Final score
  â”‚   â”‚           â””â”€ Study Report (if failed)
  â”‚   â”‚
  â”‚   â””â”€ Tab: "History"
  â”‚       â”‚
  â”‚       â”œâ”€ Dungeon Runs List
  â”‚       â”‚   â””â”€ Each run: score, rooms, date, skills
  â”‚       â”‚
  â”‚       â””â”€ Skills to Review
  â”‚           â””â”€ Top 5 failed skills
  â”‚
  â””â”€ API Calls
      â”œâ”€ /api/dungeon/stats (GET game stats)
      â”œâ”€ /api/dungeon/run (GET past runs)
      â”œâ”€ /api/dungeon/run (POST start new run)
      â”œâ”€ /api/dungeon/generate (POST get questions)
      â””â”€ /api/dungeon/answer (POST submit answer)
```

---

## ğŸ¨ UI State Machine

```
MENU â†’ [Click "Enter"] â†’ LOADING â†’ [Questions ready] â†’ PLAYING
                                                          â”‚
                                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                                     â”‚
               HP = 0                              All rooms cleared
                    â”‚                                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                            GAME OVER
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
              [Try Again]               [Exit Dungeon]
                    â”‚                         â”‚
                    â–¼                         â–¼
                 LOADING                    MENU
```

This visual architecture shows exactly how all the pieces fit together! ğŸ®âœ¨
